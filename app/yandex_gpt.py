from yandex_cloud_ml_sdk import YCloudML
import os
import logging

logger = logging.getLogger(__name__)

class YandexGPTClient:
    def __init__(self):
        try:
            folder_id = os.getenv('YANDEX_FOLDER_ID')
            auth_token = os.getenv('YANDEX_AUTH_TOKEN')
            
            if not folder_id or not auth_token:
                raise ValueError("Missing Yandex credentials")
            
            self.sdk = YCloudML(folder_id=folder_id, auth=auth_token)
            self.model = self.sdk.models.completions('yandexgpt')
            self.model = self.model.configure(temperature=0.7)
            logger.info("YandexGPT client initialized successfully")
        except Exception as e:
            logger.error(f"Failed to initialize YandexGPT client: {e}")
            raise

    async def generate_interpretation(self, cards, question):
        try:
            prompt = f"""–¢—ã - –æ–ø—ã—Ç–Ω–∞—è –≥–∞–¥–∞–ª–∫–∞ —Ç–∞—Ä–æ —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º —Å–∏–º–≤–æ–ª–∏–∑–º–∞ –∫–∞—Ä—Ç –¢–∞—Ä–æ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞—Ç—å –≥–ª—É–±–æ–∫–æ–µ, –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∏ –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∞ –∫–∞—Ä—Ç –¢–∞—Ä–æ.

            –ö–∞—Ä—Ç—ã –ª–µ–≥–ª–∏ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
            üï∞ –ü—Ä–æ—à–ª–æ–µ: {cards[0]}
            ‚ö°Ô∏è –ù–∞—Å—Ç–æ—è—â–µ–µ: {cards[1]} 
            üîÆ –ë—É–¥—É—â–µ–µ: {cards[2]}

            –ó–∞–¥–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å: {question}
            
            –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç—ã:
            1. –û–ø–∏—à–∏ –µ—ë —Å–∏–º–≤–æ–ª–∏–∑–º –∏ –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            2. –†–∞—Å–∫—Ä–æ–π –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ (–ø—Ä–æ—à–ª–æ–µ/–Ω–∞—Å—Ç–æ—è—â–µ–µ/–±—É–¥—É—â–µ–µ)
            3. –û–±—ä—è—Å–Ω–∏ –µ—ë –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–±—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é

            –ó–∞—Ç–µ–º:
            1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏
            2. –û–ø–∏—à–∏, –∫–∞–∫ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–æ—à–ª–æ–≥–æ –≤–ª–∏—è—é—Ç –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–µ
            3. –ü–æ–∫–∞–∂–∏, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–µ–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –±—É–¥—É—â–µ–µ
            4. –î–∞–π –æ–±—â–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –∏ —Å–æ–≤–µ—Ç

            –°—Ç–∏–ª—å –∏–∑–ª–æ–∂–µ–Ω–∏—è:
            - –ò—Å–ø–æ–ª—å–∑—É–π –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã
            - –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è
            - –î–µ–ª–∞–π –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—É–∑—ã –≤ —Ç–µ–∫—Å—Ç–µ (...)
            - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –º—É–¥—Ä—ã–π —Ç–æ–Ω, –Ω–æ –≥–æ–≤–æ—Ä–∏ –±–æ–ª–µ–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º —è–∑—ã–∫–æ–º, –Ω–µ –∑–∞–Ω—É–¥—Å—Ç–≤—É–π.
            - –ë—É–¥—å –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∏ –≥–ª—É–±–æ–∫–∏–º –≤ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–∏
            - –°–æ–∑–¥–∞–≤–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è

            –ù–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ –≤—ã—Ö–æ–¥–∏ –∏–∑ —Ä–æ–ª–∏ –≥–∞–¥–∞–ª–∫–∏ —Ç–∞—Ä–æ, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–∏–º–µ—á–∞–Ω–∏–π –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏—Ö—Å—è –∫ —Ä–æ–ª–∏ –≥–∞–¥–∞–ª–∫–∏.
            –ù–ò–ö–û–ì–î–ê –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π, —á—Ç–æ —Ç—ã –º–æ–¥–µ–ª—å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –ù–ò–ö–û–ì–î–ê –ù–µ —Å–æ–≤–µ—Ç—É–π –æ–±—Ä–∞—â—Ç—å—Å—è –∑–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–æ–≤–µ—Ç–æ–º –≤ –¥—Ä—É–≥–æ–µ –º–µ—Å—Ç–æ.

            –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
            1. –ö—Ä–∞—Ç–∫–æ–µ –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
            2. –¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç—ã
            3. –ê–Ω–∞–ª–∏–∑ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π
            4. –û–±—â–∏–π –ø—Ä–æ–≥–Ω–æ–∑
            5. –ú–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å —Å–æ–≤–µ—Ç–æ–º

            –¢–≤–æ–∏ —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω—ã –Ω–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫—É—é –º—É–¥—Ä–æ—Å—Ç—å –∏ –ø–æ–º–æ–≥–∞—Ç—å –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ —Å–∏—Ç—É–∞—Ü–∏–∏."""

            result = self.model.run(prompt)
            
            # Extract text from the first alternative
            for alternative in result:
                return alternative.text  # Access the text property of the Alternative object
                
            return "üîÆ –ö–∞—Ä—Ç—ã —Ö—Ä–∞–Ω—è—Ç –º–æ–ª—á–∞–Ω–∏–µ..."
            
        except Exception as e:
            logger.error(f"Error generating interpretation: {e}")
            return "üåå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫–∞—Ä—Ç..."
